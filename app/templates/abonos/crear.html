{% extends "base.html" %}

{% block title %}Registrar Abono - CreditApp{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Registrar Abono</h1>
        <div>
            <a href="{{ url_for('abonos.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Datos del Abono</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="abonoForm">
                        {{ form.hidden_tag() }}

                        <!-- Cliente -->
                        <div class="mb-3">
                            <label class="form-label">Cliente *</label>
                            <div class="input-group mb-2">
                                <select class="form-select" id="cliente_select" name="cliente_id" required>
                                    {% for id, nombre in form.cliente_id.choices %}
                                        <option value="{{ id }}" {% if form.cliente_id.data == id %}selected{% endif %}>{{ nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="buscar-cliente" placeholder="Buscar cliente...">
                                <button type="button" class="btn btn-outline-secondary" id="btn-buscar-cliente">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Campo oculto para tipo_credito -->
                        <input type="hidden" name="tipo_credito" value="venta" id="tipo_credito">

                        <!-- Venta a abonar -->
                        <div class="mb-3">
                            <label class="form-label">Venta/Crédito *</label>
                            <select class="form-select" id="venta_select" name="venta_id" required>
                                {% for id, texto in form.venta_id.choices %}
                                    <option value="{{ id }}" {% if form.venta_id.data == id %}selected{% endif %}>{{ texto }}</option>
                                {% endfor %}
                            </select>
                            <div id="saldo_info" class="form-text"></div>
                        </div>

                        <!-- Monto del abono -->
                        <div class="mb-3">
    <label class="form-label">Monto *</label>
    <div class="input-group">
        <span class="input-group-text">$</span>
        <!-- Cambiado a type="text" para permitir valores más grandes -->
        <input type="text" class="form-control" id="monto_input" name="monto" required
               value="{{ form.monto.data or '' }}" placeholder="Ingrese el monto (ej: 116000)">
    </div>
    <small class="form-text text-muted">Ingrese el monto sin puntos ni comas para valores grandes.</small>
</div>

<!-- JavaScript mejorado para procesar el monto -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const buscarClienteInput = document.getElementById('buscar-cliente');
    const clienteSelect = document.getElementById('cliente_select');
    const ventaSelect = document.getElementById('venta_select');
    const montoInput = document.getElementById('monto_input');
    const saldoInfo = document.getElementById('saldo_info');
    const btnBuscarCliente = document.getElementById('btn-buscar-cliente');

    // Función para extraer y mostrar el saldo pendiente
    function actualizarSaldoInfo() {
        if (ventaSelect.selectedIndex > 0) {
            const selectedText = ventaSelect.options[ventaSelect.selectedIndex].text;
            const saldoMatch = selectedText.match(/Saldo: \$([\d,\.]+)/);
            
            if (saldoMatch && saldoMatch[1]) {
                // Extraer el saldo pendiente correctamente
                const saldoPendienteStr = saldoMatch[1].replace(/,/g, '');
                const saldoPendiente = parseFloat(saldoPendienteStr);
                saldoInfo.textContent = `Saldo pendiente: $${saldoPendiente.toLocaleString('es')}`;
                
                // Sugerir el saldo pendiente como valor inicial
                if (!montoInput.value) {
                    montoInput.value = saldoPendiente;
                }
            } else {
                saldoInfo.textContent = '';
            }
        } else {
            saldoInfo.textContent = '';
        }
    }

    // Actualizar ventas cuando cambia el cliente
    if (clienteSelect) {
        clienteSelect.addEventListener('change', function() {
            const clienteId = this.value;
            if (!clienteId || clienteId < 0) return;
            
            // Limpiar el selector de ventas y mostrar cargando
            ventaSelect.innerHTML = '<option value="" selected>Cargando ventas...</option>';
            saldoInfo.textContent = '';
            
            // Cargar ventas del cliente seleccionado
            fetch(`/abonos/cargar-ventas/${clienteId}`)
                .then(response => response.json())
                .then(ventas => {
                    ventaSelect.innerHTML = '';
                    
                    if (ventas.length === 0) {
                        ventaSelect.innerHTML = '<option value="" selected>No hay ventas pendientes</option>';
                        return;
                    }
                    
                    // Agregar opción por defecto
                    ventaSelect.innerHTML = '<option value="" selected>Seleccione una venta</option>';
                    
                    // Agregar las ventas disponibles
                    ventas.forEach(venta => {
                        const option = document.createElement('option');
                        option.value = venta.id;
                        option.textContent = venta.texto;
                        ventaSelect.appendChild(option);
                    });
                    
                    // Si hay parámetro venta_id en la URL, seleccionarla
                    const urlParams = new URLSearchParams(window.location.search);
                    const ventaId = urlParams.get('venta_id');
                    
                    if (ventaId) {
                        const option = ventaSelect.querySelector(`option[value="${ventaId}"]`);
                        if (option) {
                            option.selected = true;
                            actualizarSaldoInfo();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al cargar ventas:', error);
                    ventaSelect.innerHTML = '<option value="" selected>Error al cargar ventas</option>';
                });
        });
    }
    
    // Filtrar clientes al escribir
    if (buscarClienteInput && clienteSelect) {
        function filtrarClientes() {
            const busqueda = buscarClienteInput.value.toLowerCase().trim();
            
            for (let i = 0; i < clienteSelect.options.length; i++) {
                const option = clienteSelect.options[i];
                if (option.value === '' || option.value < 0) continue;  // Saltar opciones no válidas
                
                const texto = option.text.toLowerCase();
                option.style.display = texto.includes(busqueda) ? '' : 'none';
            }
        }
        
        buscarClienteInput.addEventListener('input', filtrarClientes);
        if (btnBuscarCliente) {
            btnBuscarCliente.addEventListener('click', filtrarClientes);
        }
    }
    
    // Actualizar saldo cuando cambia la venta
    if (ventaSelect) {
        ventaSelect.addEventListener('change', actualizarSaldoInfo);
    }
    
    // Validar y formatear el monto
    if (montoInput) {
        montoInput.addEventListener('input', function() {
            // Permitir solo dígitos, punto y coma
            this.value = this.value.replace(/[^\d.,]/g, '');
            
            // Validar que no exceda el saldo pendiente
            if (!saldoInfo || !saldoInfo.textContent) return;
            
            const saldoMatch = saldoInfo.textContent.match(/\$([\d,\.]+)/);
            if (saldoMatch && saldoMatch[1]) {
                // Extraer y procesar el saldo pendiente
                const saldoStr = saldoMatch[1].replace(/,/g, '');
                const saldoPendiente = parseFloat(saldoStr);
                
                // Procesar el monto ingresado
                const montoStr = this.value.replace(/,/g, '.');
                const monto = parseFloat(montoStr);
                
                // Validar que el monto no sea mayor al saldo pendiente
                if (!isNaN(monto) && monto > saldoPendiente) {
                    this.value = saldoPendiente.toString();
                    alert(`El monto no puede ser mayor al saldo pendiente ($${saldoPendiente.toLocaleString('es')})`);
                }
            }
        });
    }
    
    // Ejecutar una vez al cargar para configurar valores iniciales
    actualizarSaldoInfo();
    
    // Si hay cliente seleccionado, disparar el evento change para cargar sus ventas
    if (clienteSelect && clienteSelect.value && clienteSelect.value > 0) {
        // Simular cambio para cargar las ventas
        clienteSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
