{% extends 'base.html' %}

{% block title %}Nueva Venta - CreditApp{% endblock %}

{% block extra_css %}
<style>
    .producto-item-disponible {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .producto-item-disponible:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .cantidad-item-venta {
        width: 70px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Nueva Venta</h1>
        <div>
            <a href="{{ url_for('ventas.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Primera columna - Datos de la venta y productos seleccionados -->
        <div class="col-md-7">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Datos de la Venta</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="ventaForm">
                        {{ form.hidden_tag() }}
                        
                        <div class="row mb-4">
                            <!-- Datos del cliente y venta -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cliente *</label>
                                <div class="input-group mb-2">
                                    {{ form.cliente(class="form-select") }}
                                </div>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="buscar-cliente" placeholder="Buscar cliente...">
                                    <button type="button" class="btn btn-outline-secondary" id="btn-buscar-cliente">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tipo de Venta *</label>
                                {{ form.tipo(class="form-select") }}
                            </div>
                        </div>

                        <!-- Sección crédito - Solo visible cuando se selecciona crédito -->
                        <div id="seccion_credito" style="display: none;" class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Frecuencia de pago *</label>
                                <select class="form-select" id="frecuencia_pago" name="frecuencia_pago">
                                    <option value="semanal">Semanal</option>
                                    <option value="quincenal">Quincenal</option>
                                    <option value="mensual" selected>Mensual</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Número de cuotas *</label>
                                <input type="number" class="form-control" id="numero_cuotas" name="numero_cuotas" min="1" value="1">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Caja *</label>
                                {{ form.caja(class="form-select") }}
                            </div>
                        </div>
                        
                        <!-- Campo oculto para los productos JSON -->
                        <input type="hidden" name="productos_json" id="productos_json">
                        {{ form.csrf_token }}
                        
                        <!-- Lista de productos seleccionados -->
                        <div class="table-responsive mt-4">
                            <h5>Productos Seleccionados</h5>
                            <table class="table table-striped" id="tabla-productos">
                                <thead class="table-light">
                                    <tr>
                                        <th>Código</th>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio Unit.</th>
                                        <th>Subtotal</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Productos seleccionados se añaden aquí con JavaScript -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="4" class="text-end">Total:</th>
                                        <th id="total-venta">$0</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Resumen de crédito - Solo visible cuando hay productos y es venta a crédito -->
                        <div id="resumen_credito" class="mt-4" style="display: none;">
                            <h5 class="mb-3">Resumen de la Venta a Crédito</h5>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Cliente:</strong> <span id="resumen_cliente_nombre"></span></p>
                                            <p><strong>Frecuencia de pago:</strong> <span id="resumen_frecuencia_pago"></span></p>
                                            <p><strong>Valor de cada cuota:</strong> <span id="resumen_valor_cuota"></span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Tipo de venta:</strong> Crédito</p>
                                            <p><strong>Número de cuotas:</strong> <span id="resumen_numero_cuotas"></span></p>
                                            <p><strong>Fecha primer pago (aprox):</strong> <span id="resumen_fecha_primer_pago"></span></p>
                                        </div>
                                    </div>
                                    <hr>
                                    <p class="fw-bold text-center">Total de la venta: <span id="resumen_total_venta_credito" class="text-primary"></span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <a href="{{ url_for('ventas.index') }}" class="btn btn-secondary me-2">Cancelar</a>
                            {{ form.submit(class="btn btn-success") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Segunda columna - Productos disponibles para seleccionar -->
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Productos Disponibles</h5>
                    <div class="input-group mt-2">
                        <input type="text" class="form-control" id="buscar-producto-disponible" placeholder="Buscar por nombre o código...">
                        <button type="button" class="btn btn-outline-primary" id="btn-buscar-producto">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                    <div class="row m-2" id="productos-disponibles-container">
                        {% if productos %}
                            {% for prod in productos %}
                                <div class="col-12 mb-2 producto-item-disponible" 
                                     data-id="{{ prod.id }}" 
                                     data-nombre="{{ prod.nombre }}" 
                                     data-precio="{{ prod.precio_venta }}" 
                                     data-stock="{{ prod.stock }}" 
                                     data-codigo="{{ prod.codigo }}">
                                    <div class="card p-2">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h6 class="card-title mb-0">{{ prod.nombre }}</h6>
                                                <small class="text-muted">Código: {{ prod.codigo }}</small>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-primary">${{ "{:,.0f}".format(prod.precio_venta) }}</span><br>
                                                <small class="text-muted">Stock: {{ prod.stock }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <p class="text-center p-3">No hay productos disponibles.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
@ventas_bp.route('/crear', methods=['GET', 'POST'])
@login_required
@vendedor_required
def crear():
    # Inicializar el formulario
    form = VentaForm()
    
    # Obtener cliente_id de la URL si existe
    cliente_id_param = request.args.get('cliente_id', type=int)
    
    # Cargar opciones para los selectores
    clientes = Cliente.query.order_by(Cliente.nombre).all()
    form.cliente.choices = [(c.id, f"{c.nombre} - {c.cedula}") for c in clientes]
    
    # Si hay un cliente_id en la URL, preseleccionarlo
    if cliente_id_param and request.method == 'GET':
        cliente = Cliente.query.get(cliente_id_param)
        if cliente:
            form.cliente.data = cliente.id
    
    # Cargar opciones para los selectores de caja
    cajas = Caja.query.all()
    form.caja.choices = [(c.id, c.nombre) for c in cajas]
    
    # Obtener productos disponibles para la vista
    productos_disponibles = Producto.query.filter(Producto.stock > 0).order_by(Producto.nombre).all()
    
    # Log para depuración
    if request.method == 'POST':
        current_app.logger.info(f"Datos del formulario recibidos: {request.form}")
        
    # Procesar el formulario cuando se envía
    if form.validate_on_submit():
        current_app.logger.info("Formulario validado correctamente")
        
        # Obtener productos del campo JSON
        productos_json = request.form.get('productos_json', '[]')
        current_app.logger.info(f"Productos JSON: {productos_json}")
        
        try:
            # Decodificar JSON de productos
            productos_seleccionados = json.loads(productos_json)
            
            # Verificar si hay productos seleccionados
            if not productos_seleccionados:
                flash('No se seleccionaron productos para la venta.', 'danger')
                return render_template('ventas/crear.html', form=form, productos=productos_disponibles)
            
            current_app.logger.info(f"Productos decodificados: {productos_seleccionados}")
            
            # Crear nueva venta
            nueva_venta = Venta(
                cliente_id=form.cliente.data,
                vendedor_id=current_user.id,
                tipo=form.tipo.data,
                fecha=datetime.utcnow(),
                total=0,  # Se calculará después
                saldo_pendiente=0  # Se calculará después
            )
            
            # Establecer estado según tipo de venta
            if form.tipo.data == 'contado':
                nueva_venta.estado = 'pagado'
            else:
                nueva_venta.estado = 'pendiente'
            
            db.session.add(nueva_venta)
            db.session.flush()  # Para obtener el ID antes del commit
            
            # Procesar los productos seleccionados
            total_venta_calculado = 0
            
            for item in productos_seleccionados:
                producto_id = int(item.get('id', 0))
                cantidad = int(item.get('cantidad', 0))
                precio_venta = float(item.get('precio_venta', 0))
                
                # Verificar stock disponible
                producto_db = Producto.query.get(producto_id)
                if not producto_db:
                    flash(f"Producto no encontrado.", 'danger')
                    db.session.rollback()
                    return render_template('ventas/crear.html', form=form, productos=productos_disponibles)
                
                if producto_db.stock < cantidad:
                    flash(f"Stock insuficiente para {producto_db.nombre}. Disponible: {producto_db.stock}", 'danger')
                    db.session.rollback()
                    return render_template('ventas/crear.html', form=form, productos=productos_disponibles)
                
                # Crear detalle de venta
                subtotal = cantidad * precio_venta
                detalle = DetalleVenta(
                    venta_id=nueva_venta.id,
                    producto_id=producto_id,
                    cantidad=cantidad,
                    precio_unitario=precio_venta,
                    subtotal=subtotal
                )
                db.session.add(detalle)
                
                # Actualizar stock
                producto_db.stock -= cantidad
                
                # Sumar al total
                total_venta_calculado += subtotal
            
            # Actualizar total y saldo pendiente
            nueva_venta.total = total_venta_calculado
            
            if form.tipo.data == 'credito':
                nueva_venta.saldo_pendiente = total_venta_calculado
            else:  # contado
                nueva_venta.saldo_pendiente = 0
                
                # Registrar movimiento en caja para ventas de contado
                try:
                    registrar_movimiento_caja(
                        caja_id=form.caja.data,
                        tipo='entrada',
                        monto=total_venta_calculado,
                        concepto=f"Venta de contado #{nueva_venta.id}",
                        venta_id=nueva_venta.id
                    )
                except Exception as e:
                    current_app.logger.error(f"Error al registrar movimiento de caja: {e}")
                    # Continuar a pesar del error en la caja
            
            # Confirmar cambios
            db.session.commit()
            flash(f'Venta #{nueva_venta.id} creada exitosamente!', 'success')
            
            # Redireccionar a la lista de ventas
            return redirect(url_for('ventas.index'))
            
        except json.JSONDecodeError as e:
            current_app.logger.error(f"Error al decodificar JSON: {e}")
            flash('Error en el formato de productos seleccionados.', 'danger')
            return render_template('ventas/crear.html', form=form, productos=productos_disponibles)
        except Exception as e:
            db.session.rollback()
            current_app.logger.error(f"Error al crear venta: {e}")
            current_app.logger.error(traceback.format_exc())
            flash(f'Error al crear la venta: {str(e)}', 'danger')
    elif request.method == 'POST':
        # Si el formulario no se validó, mostrar errores
        current_app.logger.warning(f"Errores de validación: {form.errors}")
        flash('Por favor corrija los errores en el formulario.', 'warning')
    
    return render_template('ventas/crear.html', form=form, productos=productos_disponibles)

document.addEventListener('DOMContentLoaded', function() {
    console.log("Inicializando JavaScript para creación de ventas");

    // Variables y elementos DOM
    window.productosSeleccionadosParaVenta = [];
    const productosDisponiblesContainer = document.getElementById('productos-disponibles-container');
    const tablaProductos = document.getElementById('tabla-productos');
    const tablaProductosVentaBody = tablaProductos ? tablaProductos.querySelector('tbody') : null;
    const inputJsonProductosOculto = document.getElementById('productos_json');
    const displayTotalVenta = document.getElementById('total-venta');
    const inputBuscarProductoDisponible = document.getElementById('buscar-producto-disponible');
    const btnBuscarProducto = document.getElementById('btn-buscar-producto');
    const inputBuscarCliente = document.getElementById('buscar-cliente');
    const btnBuscarCliente = document.getElementById('btn-buscar-cliente');
    const formularioVenta = document.getElementById('ventaForm');
    
    const selectTipoVenta = document.querySelector('select[name="tipo"]');
    const divSeccionCredito = document.getElementById('seccion_credito');
    const divResumenCredito = document.getElementById('resumen_credito');
    const selectFrecuenciaPago = document.getElementById('frecuencia_pago');
    const inputNumeroCuotas = document.getElementById('numero_cuotas');
    const clienteSelect = document.querySelector('select[name="cliente"]');

    // Validación de elementos críticos
    if (!productosDisponiblesContainer) {
        console.error("Error crítico: No se encontró el contenedor de productos disponibles");
    }
    
    if (!tablaProductos || !tablaProductosVentaBody) {
        console.error("Error crítico: No se encontró la tabla de productos o su cuerpo");
    }
    
    if (!inputJsonProductosOculto) {
        console.error("Error crítico: No se encontró el campo oculto para JSON de productos");
    }

    // Objeto para almacenar el stock disponible actualizado
    const stockActualizado = {};

    // Inicializar stock actual
    if (productosDisponiblesContainer) {
        const items = productosDisponiblesContainer.querySelectorAll('.producto-item-disponible');
        items.forEach(item => {
            const id = parseInt(item.dataset.id);
            stockActualizado[id] = parseInt(item.dataset.stock);
            console.log(`Inicializando stock para producto ID ${id}: ${stockActualizado[id]}`);
        });
    }

    // Formateador de moneda
    const currencyFormatter = new Intl.NumberFormat('es-CO', { 
        style: 'currency', 
        currency: 'COP', 
        minimumFractionDigits: 0, 
        maximumFractionDigits: 0 
    });

    // Filtrar clientes al escribir en el buscador
    if (inputBuscarCliente && clienteSelect) {
        function filtrarClientes() {
            const busqueda = inputBuscarCliente.value.toLowerCase().trim();
            
            for (let i = 0; i < clienteSelect.options.length; i++) {
                const option = clienteSelect.options[i];
                if (option.value === '') continue;  // Saltar la opción por defecto
                
                const texto = option.text.toLowerCase();
                option.style.display = texto.includes(busqueda) ? '' : 'none';
            }
        }
        
        inputBuscarCliente.addEventListener('input', filtrarClientes);
        if (btnBuscarCliente) {
            btnBuscarCliente.addEventListener('click', filtrarClientes);
        }
    }

    // Mostrar/ocultar sección de crédito
    if (selectTipoVenta) {
        selectTipoVenta.addEventListener('change', function() {
            const esCredito = this.value === 'credito';
            if (divSeccionCredito) divSeccionCredito.style.display = esCredito ? 'flex' : 'none';
            if (divResumenCredito) divResumenCredito.style.display = esCredito && window.productosSeleccionadosParaVenta.length > 0 ? 'block' : 'none';
            if (esCredito) {
                actualizarResumenVentaCredito();
            }
        });
    }

    function actualizarResumenVentaCredito() {
        if (!selectTipoVenta || !divResumenCredito || selectTipoVenta.value !== 'credito' || window.productosSeleccionadosParaVenta.length === 0) {
            if (divResumenCredito) divResumenCredito.style.display = 'none';
            return;
        }

        try {
            const opcionClienteSeleccionado = clienteSelect.options[clienteSelect.selectedIndex];
            const nombreCliente = opcionClienteSeleccionado && opcionClienteSeleccionado.value ? opcionClienteSeleccionado.text.split(' - ')[0] : 'N/A';
            const textoFrecuencia = selectFrecuenciaPago.options[selectFrecuenciaPago.selectedIndex].text;
            const numCuotas = parseInt(inputNumeroCuotas.value) || 1;
            const totalVentaActual = window.productosSeleccionadosParaVenta.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);

            document.getElementById('resumen_cliente_nombre').textContent = nombreCliente;
            document.getElementById('resumen_frecuencia_pago').textContent = textoFrecuencia;
            document.getElementById('resumen_numero_cuotas').textContent = numCuotas;
            document.getElementById('resumen_valor_cuota').textContent = currencyFormatter.format(numCuotas > 0 ? totalVentaActual / numCuotas : totalVentaActual);
            
            const hoy = new Date();
            let diasParaPrimerPago = 30; // mensual por defecto
            if (selectFrecuenciaPago.value === 'semanal') diasParaPrimerPago = 7;
            else if (selectFrecuenciaPago.value === 'quincenal') diasParaPrimerPago = 15;
            
            const fechaPrimerPago = new Date(hoy);
            fechaPrimerPago.setDate(hoy.getDate() + diasParaPrimerPago);
            document.getElementById('resumen_fecha_primer_pago').textContent = `${fechaPrimerPago.getDate().toString().padStart(2, '0')}/${(fechaPrimerPago.getMonth() + 1).toString().padStart(2, '0')}/${fechaPrimerPago.getFullYear()}`;
            document.getElementById('resumen_total_venta_credito').textContent = currencyFormatter.format(totalVentaActual);
            
            divResumenCredito.style.display = 'block';
        } catch (e) {
            console.error("Error al actualizar resumen de crédito:", e);
        }
    }

    if (selectFrecuenciaPago) selectFrecuenciaPago.addEventListener('change', actualizarResumenVentaCredito);
    if (inputNumeroCuotas) inputNumeroCuotas.addEventListener('input', actualizarResumenVentaCredito);
    if (clienteSelect) clienteSelect.addEventListener('change', actualizarResumenVentaCredito);

    // Función para actualizar visualmente el stock disponible
    function actualizarVisualizacionStock() {
        if (!productosDisponiblesContainer) return;
        
        const items = productosDisponiblesContainer.querySelectorAll('.producto-item-disponible');
        items.forEach(item => {
            const id = parseInt(item.dataset.id);
            
            // Si el producto está en el control de stock, actualizar visualización
            if (id in stockActualizado) {
                const stockRestante = stockActualizado[id];
                
                // Actualizar el texto del stock
                const stockText = item.querySelector('small.text-muted:last-child');
                if (stockText) {
                    stockText.textContent = `Stock: ${stockRestante}`;
                    
                    // Cambiar color si el stock está bajo o agotado
                    if (stockRestante <= 0) {
                        item.classList.add('bg-danger', 'text-white');
                        item.style.opacity = '0.5';
                        item.style.cursor = 'not-allowed';
                    } else if (stockRestante <= 5) {
                        item.classList.add('bg-warning');
                        item.classList.remove('bg-danger', 'text-white');
                        item.style.opacity = '1';
                        item.style.cursor = 'pointer';
                    } else {
                        item.classList.remove('bg-warning', 'bg-danger', 'text-white');
                        item.style.opacity = '1';
                        item.style.cursor = 'pointer';
                    }
                }
            }
        });
    }

    // Renderizar tabla de productos seleccionados
    function renderTablaProductosSeleccionados() {
        if (!tablaProductosVentaBody) return;
        
        tablaProductosVentaBody.innerHTML = '';
        let granTotal = 0;

        window.productosSeleccionadosParaVenta.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            granTotal += subtotal;

            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td>${producto.codigo}</td>
                <td>${producto.nombre}</td>
                <td>
                    <input type="number" class="form-control form-control-sm cantidad-item-venta" 
                        value="${producto.cantidad}" min="1" max="${producto.stockMax}" 
                        data-index="${index}" data-id="${producto.id}">
                </td>
                <td class="text-end">${currencyFormatter.format(producto.precio)}</td>
                <td class="text-end subtotal">${currencyFormatter.format(subtotal)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger eliminar-item-venta" data-index="${index}" data-id="${producto.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tablaProductosVentaBody.appendChild(fila);
        });

        if (displayTotalVenta) {
            displayTotalVenta.textContent = currencyFormatter.format(granTotal);
        }
        
        // Preparar el JSON para el backend
        const productosParaEnviar = window.productosSeleccionadosParaVenta.map(p => ({
            id: p.id,
            cantidad: p.cantidad,
            precio_venta: p.precio
        }));
        
        if (inputJsonProductosOculto) {
            inputJsonProductosOculto.value = JSON.stringify(productosParaEnviar);
            console.log("JSON actualizado:", inputJsonProductosOculto.value);
        }
            
        actualizarResumenVentaCredito(); // Actualizar resumen si es crédito
        bindEventosItemsTabla();
    }

    // Agregar eventos a los elementos de la tabla de productos seleccionados
    function bindEventosItemsTabla() {
        document.querySelectorAll('.cantidad-item-venta').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const productoId = parseInt(this.dataset.id);
                let nuevaCantidad = parseInt(this.value);
                
                if (isNaN(nuevaCantidad) || nuevaCantidad < 1) {
                    nuevaCantidad = 1;
                    this.value = 1;
                }
                
                const producto = window.productosSeleccionadosParaVenta[index];
                if (!producto) {
                    console.error("Producto no encontrado en el índice:", index);
                    return;
                }
                
                // Calcular el máximo stock permitido
                let cantidadPrevia = producto.cantidad;
                
                // Restablecer el stock al valor anterior antes de recalcular
                stockActualizado[productoId] += cantidadPrevia;
                
                // Verificar si la nueva cantidad excede el stock disponible
                if (nuevaCantidad > stockActualizado[productoId]) {
                    nuevaCantidad = stockActualizado[productoId];
                    this.value = nuevaCantidad;
                    alert(`La cantidad no puede exceder el stock disponible (${stockActualizado[productoId]}).`);
                }
                
                // Actualizar la cantidad y el stock
                producto.cantidad = nuevaCantidad;
                stockActualizado[productoId] -= nuevaCantidad;
                
                renderTablaProductosSeleccionados();
                actualizarVisualizacionStock();
            });
        });

        document.querySelectorAll('.eliminar-item-venta').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                const productoId = parseInt(this.dataset.id);
                const cantidadEliminada = window.productosSeleccionadosParaVenta[index].cantidad;
                
                // Restablecer el stock
                stockActualizado[productoId] += cantidadEliminada;
                
                // Eliminar el producto de la lista
                window.productosSeleccionadosParaVenta.splice(index, 1);
                
                renderTablaProductosSeleccionados();
                actualizarVisualizacionStock();
            });
        });
    }

    // Buscar productos disponibles
    function buscarProductos() {
        const busqueda = inputBuscarProductoDisponible ? inputBuscarProductoDisponible.value.toLowerCase().trim() : '';
        document.querySelectorAll('#productos-disponibles-container .producto-item-disponible').forEach(item => {
            const nombre = item.dataset.nombre.toLowerCase();
            const codigo = item.dataset.codigo.toLowerCase();
            item.style.display = (nombre.includes(busqueda) || codigo.includes(busqueda)) ? 'block' : 'none';
        });
    }

    if (inputBuscarProductoDisponible) {
        inputBuscarProductoDisponible.addEventListener('input', buscarProductos);
    }
    
    if (btnBuscarProducto) {
        btnBuscarProducto.addEventListener('click', buscarProductos);
    }

    // PARTE CRUCIAL: Manejar eventos de clic en productos disponibles
    if (productosDisponiblesContainer) {
        console.log("Configurando evento de clic en productos disponibles");
        
        // Usar addEventListener para los contenedores individuales de productos
        const productosItems = productosDisponiblesContainer.querySelectorAll('.producto-item-disponible');
        productosItems.forEach(item => {
            item.addEventListener('click', function(e) {
                console.log("Clic en producto:", this.dataset.nombre);
                
                // Extraer datos del producto desde el dataset
                const id = parseInt(this.dataset.id);
                const nombre = this.dataset.nombre;
                const precio = parseFloat(this.dataset.precio);
                const codigo = this.dataset.codigo;
                const stockOriginal = parseInt(this.dataset.stock);
                
                console.log("Datos del producto:", id, nombre, precio, codigo, stockOriginal);
                
                // Usar el stock actualizado si existe, sino el original
                const stockActual = stockActualizado[id] !== undefined ? stockActualizado[id] : stockOriginal;

                // Buscar si el producto ya está en la lista
                const productoYaSeleccionado = window.productosSeleccionadosParaVenta.find(p => p.id === id);

                if (productoYaSeleccionado) {
                    // Si ya está en la lista, incrementar cantidad
                    if (stockActual > 0) {
                        productoYaSeleccionado.cantidad++;
                        // Actualizar el stock restante
                        stockActualizado[id] = stockActual - 1;
                        console.log(`Producto ${nombre} incrementado, nueva cantidad: ${productoYaSeleccionado.cantidad}`);
                    } else {
                        alert(`No hay más stock disponible para ${nombre}.`);
                    }
                } else {
                    // Si no está en la lista, agregarlo
                    if (stockActual > 0) {
                        window.productosSeleccionadosParaVenta.push({ 
                            id, 
                            codigo, 
                            nombre, 
                            precio, 
                            cantidad: 1, 
                            stockMax: stockActual 
                        });
                        // Actualizar el stock restante
                        stockActualizado[id] = stockActual - 1;
                        console.log(`Producto nuevo agregado: ${nombre}`);
                    } else {
                        alert(`El producto ${nombre} está agotado.`);
                    }
                }
                
                // Actualizar la visualización
                renderTablaProductosSeleccionados();
                actualizarVisualizacionStock();
            });
        });
    }

    // Validación del formulario al enviar
    if (formularioVenta) {
        formularioVenta.addEventListener('submit', function(e) {
            // Verificar productos seleccionados
            if (window.productosSeleccionadosParaVenta.length === 0) {
                e.preventDefault();
                alert('Debe seleccionar al menos un producto para crear la venta.');
                return false;
            }
            
            // Verificar cliente seleccionado
            const clienteSelect = document.querySelector('select[name="cliente"]');
            if (!clienteSelect || !clienteSelect.value) {
                e.preventDefault();
                alert('Debe seleccionar un cliente para crear la venta.');
                return false;
            }
            
            // Asegurar que el JSON esté actualizado justo antes del submit
            if (inputJsonProductosOculto) {
                const productosParaEnviar = window.productosSeleccionadosParaVenta.map(p => ({
                    id: p.id,
                    cantidad: p.cantidad,
                    precio_venta: p.precio
                }));
                inputJsonProductosOculto.value = JSON.stringify(productosParaEnviar);
                
                console.log('Enviando formulario con productos:', inputJsonProductosOculto.value);
            }
            
            return true;
        });
    }
    
    // Llamada inicial si el tipo de venta es crédito al cargar
    if (selectTipoVenta && selectTipoVenta.value === 'credito' && divSeccionCredito) {
        divSeccionCredito.style.display = 'flex';
    }
    
    console.log("Inicialización de JavaScript completada para ventas");
});
</script>
{% endblock %}
